{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">

  {% if sin_datos %}
    <div class="alert alert-warning">
      No se encontraron datos de consolidado para el CUIT <strong>{{ cuit }}</strong>.
    </div>
    <a class="btn btn-secondary" href="{% url 'art:consulta_busqueda' %}">
      <i class="bi bi-arrow-left"></i> Volver
    </a>
  {% else %}

    <!-- HEADER -->
    <div class="card shadow-sm mb-3 border-0" style="overflow:hidden;">
      <div class="px-3 py-3 position-relative d-flex align-items-center"
           style="background:#003366;color:#fff;">
        <div class="me-3 d-none d-sm-flex align-items-center justify-content-center"
             style="width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.12);">
          <i class="bi bi-person-badge" style="font-size:22px;"></i>
        </div>
        <div>
          <h2 class="mb-0" style="line-height:1.1;">{{ titulo }}</h2>
          <div class="text-white-50" style="font-size:.95rem;">CUIT: {{ cuit }}</div>
        </div>

        <div class="position-absolute" style="right:12px; bottom:10px;">
          {% if badges.no_contactar %}
            <span class="badge bg-danger me-2">No contactar</span>
          {% endif %}
          {% if badges.premier %}
            <span class="badge bg-primary me-2">Premier</span>
          {% endif %}
          {% if badges.cliente_importante %}
            <span class="badge bg-warning text-dark">Cliente importante</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- DATOS PRINCIPALES -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4"><strong>Contrato:</strong> {{ contrato|default:"—" }}</div>
          <div class="col-md-4"><strong>Aseguradora:</strong> {{ aseguradora|default:"—" }}</div>
          <div class="col-md-4">
            <strong>Costo mensual:</strong>
            {% if costo_mensual_fmt %}{{ costo_mensual_fmt }}{% else %}—{% endif %}
          </div>

          <div class="col-md-4"><strong>Q períodos deudores:</strong> {{ q_periodos_deudores|default:"—" }}</div>
          <div class="col-md-4"><strong>Estado contrato:</strong> {{ estado_contrato|default:"—" }}</div>
          <div class="col-md-4"><strong>Productor:</strong> {{ productor|default:"PROMECOR" }}</div>

          <div class="col-md-6"><strong>Email del trato:</strong> {{ email_trato|default:"—" }}</div>
        </div>
      </div>
    </div>

    <!-- EVOLUCIÓN -->
    <div class="row">
      <div class="col-lg-6">
        <div class="card shadow-sm mb-3">
          <div class="card-header" style="background-color:#dcdcdc;">
            <strong>Evolución de deuda</strong>
          </div>
          <div class="card-body p-0">
            <table class="table table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width:40%">Periodo</th>
                  <th style="width:60%">Deuda</th>
                </tr>
              </thead>
              <tbody>
                {% for r in evolucion_tabla %}
                <tr>
                  <td>{{ r.periodo }}</td>
                  <td>{{ r.deuda }}</td>
                </tr>
                {% empty %}
                <tr class="text-muted">
                  <td>—</td>
                  <td>Sin datos de evolución.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm mb-3">
          <div class="card-header" style="background-color:#dcdcdc;">
            <strong>Visualización</strong>
          </div>
          <div class="card-body">
            <canvas id="evolChart" height="140"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- COMBO: Variación mensual (Δ) + Q períodos -->
    <div class="card shadow-sm mb-4">
      <div class="card-header" style="background-color:#dcdcdc;">
        <strong>Variación mensual (Δ) y Q períodos</strong>
      </div>
      <div class="card-body">
        <canvas id="comboChart" height="110"></canvas>
      </div>
    </div>

    <!-- MAILS ENVIADOS -->
    <div class="card shadow-sm mb-4">
      <div class="card-header" style="background-color:#dcdcdc;">
        <strong>Mails enviados a esta cuenta</strong>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:18%">Fecha</th>
              <th style="width:42%">Asunto</th>
              <th style="width:15%">Estado</th>
              <th style="width:25%">Destinatarios</th>
            </tr>
          </thead>
          <tbody>
            {% for m in emails %}
            <tr>
              <td>{{ m.creado_en|date:"d/m/Y H:i" }}</td>
              <td>{{ m.asunto }}</td>
              <td>
                {% if m.estado == "enviado" %}
                  <span class="badge bg-success">Enviado</span>
                {% elif m.estado == "fallido" %}
                  <span class="badge bg-danger">Fallido</span>
                {% else %}
                  <span class="badge bg-secondary">{{ m.estado|title }}</span>
                {% endif %}
              </td>
              <td>
                {% if m.destinatarios %}
                  {{ m.destinatarios|join:", " }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr class="text-muted">
              <td>—</td>
              <td>Sin envíos registrados.</td>
              <td>—</td>
              <td>—</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <a class="btn btn-secondary" href="{% url 'art:consulta_busqueda' %}">
      <i class="bi bi-arrow-left"></i> Volver
    </a>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Gráfico línea (curva) de Evolución -->
    <script>
      (function () {
        const labels = JSON.parse('{{ evol_labels_json|escapejs }}');
        const values = JSON.parse('{{ evol_values_json|escapejs }}');
        const canvas = document.getElementById('evolChart');
        if (!canvas || !Array.isArray(labels) || !Array.isArray(values) || labels.length === 0) return;
        const ctx = canvas.getContext('2d');

        const fmtARS = (n) => {
          try { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(n); }
          catch { return '$ ' + (n ?? 0).toLocaleString('es-AR'); }
        };

        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Deuda',
              data: values,
              fill: false,
              cubicInterpolationMode: 'monotone',
              tension: 0.4
            }]
          },
          options: {
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => 'Deuda: ' + fmtARS(c.parsed.y) } } },
            scales: {
              x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
              y: { beginAtZero: true, ticks: { callback: (v) => fmtARS(v) } }
            }
          }
        });
      })();
    </script>

    <!-- Gráfico combinado: Barras (Δ) + Línea Q -->
    <script>
      (function () {
        const labels = JSON.parse('{{ evol_labels_json|escapejs }}');
        const values = JSON.parse('{{ evol_values_json|escapejs }}');
        const el = document.getElementById('comboChart');
        if (!el || !Array.isArray(labels) || !Array.isArray(values) || !labels.length) return;

        // Δ vs mes anterior
        const diffs = values.map((v, i) => i === 0 ? null : +(v - values[i - 1]).toFixed(2));
        const abs = (n) => Math.abs(n ?? 0);
        const maxAbs = Math.max(0, ...diffs.filter(v => v !== null).map(abs));

        // Colores por signo
        const bg = diffs.map(v =>
          v == null ? 'rgba(0,0,0,0)' : (v >= 0 ? 'rgba(46,160,67,0.6)' : 'rgba(219,54,54,0.6)')
        );
        const bd = diffs.map(v =>
          v == null ? 'rgba(0,0,0,0)' : (v >= 0 ? 'rgba(46,160,67,1)'   : 'rgba(219,54,54,1)')
        );

        const fmtARS = (n) => {
          try { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(n); }
          catch { return '$ ' + (n ?? 0).toLocaleString('es-AR'); }
        };
        const fmtSignARS = (n) => (n > 0 ? '+' : '') + fmtARS(n);

        // Q (opcional)
        let qValues = null;
        try { qValues = JSON.parse('{{ q_values_json|default:"null"|escapejs }}'); } catch {}
        const hasQ = Array.isArray(qValues) && qValues.length === labels.length;

        new Chart(el.getContext('2d'), {
          data: {
            labels,
            datasets: [
              {
                type: 'bar',
                label: 'Δ Deuda vs mes anterior',
                data: diffs,
                yAxisID: 'y',
                backgroundColor: bg,
                borderColor: bd,
                borderWidth: 1,
                barPercentage: 0.55,
                categoryPercentage: 0.7
              },
              ...(hasQ ? [{
                type: 'line',
                label: 'Q períodos deudores',
                data: qValues,
                yAxisID: 'y1',
                cubicInterpolationMode: 'monotone',
                tension: 0.4,
                spanGaps: true
              }] : [])
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: true, position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (c) => {
                    const name = c.dataset.label || '';
                    const y = c.parsed.y;
                    return name + ': ' + (c.dataset.type === 'bar' ? fmtSignARS(y) : (y ?? ''));
                  }
                }
              }
            },
            scales: {
              x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
              y: {
                beginAtZero: true,
                suggestedMin: -maxAbs * 1.15,
                suggestedMax:  maxAbs * 1.15,
                grid: {
                  color: ctx => (ctx.tick.value === 0 ? 'rgba(0,0,0,0.25)' : 'rgba(0,0,0,0.06)'),
                  lineWidth: ctx => (ctx.tick.value === 0 ? 1.2 : 0.6)
                },
                ticks: { callback: (v) => fmtARS(v) }
              },
              y1: {
                position: 'right',
                beginAtZero: true,
                grid: { drawOnChartArea: false },
                suggestedMax: 12,
                display: hasQ
              }
            }
          }
        });
      })();
    </script>

  {% endif %}
</div>
{% endblock %}
